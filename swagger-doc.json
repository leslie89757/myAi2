{"openapi":"3.0.0","info":{"title":"ChatGPT API","version":"1.0.0","description":"ChatGPT API文档，包含流式和非流式接口","contact":{"name":"开发团队"}},"servers":[{"url":"http://localhost:3000","description":"开发服务器"}],"components":{"securitySchemes":{"bearerAuth":{"type":"http","scheme":"bearer","bearerFormat":"JWT","description":"JWT认证，在请求头中添加：Authorization: Bearer {token}"}}},"security":[{"bearerAuth":[]}],"paths":{"/api/auth/login":{"post":{"tags":["认证"],"summary":"用户登录/注册","description":"使用用户名/邮箱和密码登录，如果用户不存在则自动注册新账号，获取JWT访问令牌和刷新令牌。\n\n注意：\n- 此端点不需要认证\n- 此端点替代了原来的 /api/users/register 和 /api/users/login 端点\n- 当用户不存在时，会自动创建新账号\n","requestBody":{"required":true,"content":{"application/json":{"schema":{"type":"object","required":["login","password"],"properties":{"login":{"type":"string","description":"用户名或电子邮件"},"password":{"type":"string","format":"password"}}}}}},"responses":{"200":{"description":"登录成功或注册并登录成功","content":{"application/json":{"schema":{"type":"object","properties":{"success":{"type":"boolean"},"accessToken":{"type":"string"},"refreshToken":{"type":"string"},"user":{"type":"object","properties":{"id":{"type":"integer"},"username":{"type":"string"},"email":{"type":"string"},"role":{"type":"string"}}},"isNewUser":{"type":"boolean","description":"指示是否为新注册用户"}}}}}},"400":{"description":"请求参数错误"},"401":{"description":"认证失败"},"500":{"description":"服务器错误"}}}},"/api/auth/refresh":{"post":{"tags":["认证"],"summary":"刷新访问令牌","description":"使用刷新令牌获取新的访问令牌，刷新令牌在Authorization请求头中提供","security":[{"bearerAuth":[]}],"responses":{"200":{"description":"刷新成功","content":{"application/json":{"schema":{"type":"object","properties":{"success":{"type":"boolean"},"accessToken":{"type":"string"}}}}}},"401":{"description":"无效的刷新令牌"},"500":{"description":"服务器错误"}}}},"/api/auth/logout":{"post":{"tags":["认证"],"summary":"用户登出","description":"使当前访问令牌和刷新令牌失效","security":[{"bearerAuth":[]}],"responses":{"200":{"description":"登出成功","content":{"application/json":{"schema":{"type":"object","properties":{"success":{"type":"boolean"},"message":{"type":"string"}}}}}},"401":{"description":"未认证"},"500":{"description":"服务器错误"}}}},"/api/auth/validate":{"get":{"tags":["认证"],"summary":"验证令牌","description":"验证当前请求中的令牌是否有效","security":[{"bearerAuth":[]}],"responses":{"200":{"description":"令牌有效","content":{"application/json":{"schema":{"type":"object","properties":{"valid":{"type":"boolean"},"user":{"type":"object","properties":{"id":{"type":"integer"},"username":{"type":"string"},"email":{"type":"string"},"role":{"type":"string"}}}}}}}},"401":{"description":"令牌无效"}}}},"/api/knowledge/upload":{"post":{"tags":["知识库"],"summary":"上传并向量化文档","description":"上传PDF、TXT、DOC或DOCX文件，解析内容并添加到用户的知识库中","security":[{"bearerAuth":[]}],"requestBody":{"required":true,"content":{"multipart/form-data":{"schema":{"type":"object","properties":{"file":{"type":"string","format":"binary","description":"要上传的文档文件"},"userId":{"type":"string","description":"用户ID"},"documentName":{"type":"string","description":"文档名称"}}}}}},"responses":{"200":{"description":"文档上传并向量化成功","content":{"application/json":{"schema":{"type":"object","properties":{"success":{"type":"boolean"},"message":{"type":"string"}}}}}},"400":{"description":"请求参数错误"},"500":{"description":"服务器错误"}}}},"/api/knowledge/query":{"post":{"tags":["知识库"],"summary":"查询知识库","description":"使用自然语言查询用户的知识库","security":[{"bearerAuth":[]}],"requestBody":{"required":true,"content":{"application/json":{"schema":{"type":"object","required":["query","userId"],"properties":{"query":{"type":"string","description":"查询文本"},"userId":{"type":"string","description":"用户ID"}}}}}},"responses":{"200":{"description":"查询成功","content":{"application/json":{"schema":{"type":"object","properties":{"results":{"type":"array","description":"查询结果数组","items":{"type":"object","properties":{"content":{"type":"string","description":"文档片段内容"},"metadata":{"type":"object","description":"文档元数据","properties":{"chunkIndex":{"type":"integer","description":"片段索引"},"totalChunks":{"type":"integer","description":"总片段数"},"userId":{"type":"string","description":"用户ID"},"timestamp":{"type":"string","format":"date-time","description":"创建时间"}}},"score":{"type":"number","format":"float","description":"相似度分数，范围从0到1，越高表示越相关"}}}}}},"example":{"results":[{"content":"这是一段文档内容...","metadata":{"chunkIndex":0,"totalChunks":5,"userId":"11","timestamp":"2025-04-28T12:00:00.000Z"},"score":0.92}]}}}},"400":{"description":"请求参数错误"},"500":{"description":"服务器错误"}}}},"/api/knowledge/chat":{"post":{"tags":["知识库"],"summary":"与知识库聊天","description":"使用用户的知识库进行聊天，返回非流式响应","security":[{"bearerAuth":[]}],"requestBody":{"required":true,"content":{"application/json":{"schema":{"type":"object","required":["message","userId"],"properties":{"message":{"type":"string","description":"用户消息"},"userId":{"type":"string","description":"用户ID"}}}}}},"responses":{"200":{"description":"聊天成功","content":{"application/json":{"schema":{"type":"object","properties":{"reply":{"type":"string","description":"AI助手的回复内容"},"sources":{"type":"array","description":"相关知识来源","items":{"type":"object","properties":{"content":{"type":"string","description":"知识来源的文本内容摘要"},"metadata":{"type":"object","description":"知识来源的元数据"}}}}}},"example":{"reply":"根据您的知识库，我发现...","sources":[{"content":"这是一段相关的文档内容...","metadata":{"chunkIndex":0,"totalChunks":5,"userId":"11"}}]}}}},"400":{"description":"请求参数错误"},"500":{"description":"服务器错误"}}}},"/api/knowledge/stream-chat":{"post":{"tags":["知识库"],"summary":"与知识库流式聊天","description":"使用用户的知识库进行聊天，返回流式响应","security":[{"bearerAuth":[]}],"requestBody":{"required":true,"content":{"application/json":{"schema":{"type":"object","required":["message","userId"],"properties":{"message":{"type":"string","description":"用户消息"},"userId":{"type":"string","description":"用户ID"}}}}}},"responses":{"200":{"description":"返回 SSE 流。\n\nSSE流中的数据格式如下：\n1. 知识来源：{\"type\":\"sources\",\"sources\":[...]}，sources是一个包含相关文档片段的数组\n2. 内容片段：{\"content\":\"...\"}，这是AI助手的回复内容，可能分多个片段发送\n3. 错误信息：{\"error\":\"...\"}，当处理请求时出错\n4. 结束标记：[DONE]，表示流结束\n","content":{"text/event-stream":{"schema":{"type":"string"},"example":"data: {\"type\":\"sources\",\"sources\":[{\"content\":\"...\",\"metadata\":{...}}]}\n\ndata: {\"content\":\"AI助手回复的一部分\"}\n\ndata: {\"content\":\"继续的回复内容\"}\n\ndata: [DONE]\n"}}},"400":{"description":"请求参数错误"},"500":{"description":"服务器错误"}}}},"/api/knowledge/delete":{"delete":{"tags":["知识库"],"summary":"删除用户知识库","description":"删除指定用户的知识库内容","security":[{"bearerAuth":[]}],"parameters":[{"in":"query","name":"documentName","schema":{"type":"string"},"description":"可选，指定要删除的文档名称"}],"responses":{"200":{"description":"删除成功","content":{"application/json":{"schema":{"type":"object","properties":{"success":{"type":"boolean"},"message":{"type":"string"}}}}}},"401":{"description":"未认证"},"500":{"description":"服务器错误"}}}},"/api/sessions":{"get":{"tags":["会话"],"summary":"获取用户会话列表","description":"获取当前认证用户的所有聊天会话","security":[{"bearerAuth":[]}],"responses":{"200":{"description":"成功获取会话列表","content":{"application/json":{"schema":{"type":"array","items":{"type":"object","properties":{"id":{"type":"string"},"title":{"type":"string"},"description":{"type":"string"},"createdAt":{"type":"string","format":"date-time"},"updatedAt":{"type":"string","format":"date-time"}}}}}}},"401":{"description":"未认证"},"500":{"description":"服务器错误"}}},"post":{"tags":["会话"],"summary":"创建新会话","description":"为当前认证用户创建新的聊天会话","security":[{"bearerAuth":[]}],"requestBody":{"required":true,"content":{"application/json":{"schema":{"type":"object","required":["title"],"properties":{"title":{"type":"string","description":"会话标题"},"description":{"type":"string","description":"会话描述（可选）"}}}}}},"responses":{"200":{"description":"成功创建会话","content":{"application/json":{"schema":{"type":"object","properties":{"id":{"type":"string"},"title":{"type":"string"},"description":{"type":"string"},"createdAt":{"type":"string","format":"date-time"}}}}}},"400":{"description":"请求参数错误"},"401":{"description":"未认证"},"500":{"description":"服务器错误"}}}},"/api/sessions/{id}":{"get":{"tags":["会话"],"summary":"获取单个会话详情","description":"获取指定ID的会话详情，包括消息历史","security":[{"bearerAuth":[]}],"parameters":[{"in":"path","name":"id","required":true,"schema":{"type":"string"},"description":"会话ID"}],"responses":{"200":{"description":"成功获取会话详情","content":{"application/json":{"schema":{"type":"object","properties":{"id":{"type":"string"},"title":{"type":"string"},"description":{"type":"string"},"createdAt":{"type":"string","format":"date-time"},"updatedAt":{"type":"string","format":"date-time"},"messages":{"type":"array","items":{"type":"object","properties":{"id":{"type":"string"},"role":{"type":"string"},"content":{"type":"string"},"createdAt":{"type":"string","format":"date-time"}}}}}}}}},"401":{"description":"未认证"},"403":{"description":"无权访问该会话"},"404":{"description":"会话不存在"},"500":{"description":"服务器错误"}}},"put":{"tags":["会话"],"summary":"更新会话信息","description":"更新指定ID的会话信息","security":[{"bearerAuth":[]}],"parameters":[{"in":"path","name":"id","required":true,"schema":{"type":"string"},"description":"会话ID"}],"requestBody":{"required":true,"content":{"application/json":{"schema":{"type":"object","properties":{"title":{"type":"string","description":"会话标题"},"description":{"type":"string","description":"会话描述"},"isActive":{"type":"boolean","description":"会话是否活跃"}}}}}},"responses":{"200":{"description":"成功更新会话","content":{"application/json":{"schema":{"type":"object","properties":{"id":{"type":"string"},"title":{"type":"string"},"description":{"type":"string"},"isActive":{"type":"boolean"},"updatedAt":{"type":"string","format":"date-time"}}}}}},"401":{"description":"未认证"},"403":{"description":"无权更新该会话"},"404":{"description":"会话不存在"},"500":{"description":"服务器错误"}}},"delete":{"tags":["会话"],"summary":"删除会话","description":"删除指定ID的会话（逻辑删除，将isActive设为false）","security":[{"bearerAuth":[]}],"parameters":[{"in":"path","name":"id","required":true,"schema":{"type":"string"},"description":"会话ID"}],"responses":{"200":{"description":"成功删除会话","content":{"application/json":{"schema":{"type":"object","properties":{"success":{"type":"boolean"},"message":{"type":"string"}}}}}},"401":{"description":"未认证"},"403":{"description":"无权删除该会话"},"404":{"description":"会话不存在"},"500":{"description":"服务器错误"}}}},"/api/sessions/{id}/messages":{"post":{"tags":["会话"],"summary":"添加消息到会话","description":"将新消息添加到指定会话","security":[{"bearerAuth":[]}],"parameters":[{"in":"path","name":"id","required":true,"schema":{"type":"string"},"description":"会话ID"}],"requestBody":{"required":true,"content":{"application/json":{"schema":{"type":"object","required":["role","content"],"properties":{"role":{"type":"string","description":"消息角色 (user 或 assistant)"},"content":{"type":"string","description":"消息内容"},"tokens":{"type":"integer","description":"消息使用的令牌数"}}}}}},"responses":{"201":{"description":"消息添加成功","content":{"application/json":{"schema":{"type":"object","properties":{"success":{"type":"boolean"},"message":{"type":"string"},"chatMessage":{"type":"object","properties":{"id":{"type":"string"},"role":{"type":"string"},"content":{"type":"string"},"createdAt":{"type":"string","format":"date-time"}}}}}}}},"401":{"description":"未认证"},"404":{"description":"会话不存在"},"500":{"description":"服务器错误"}}},"delete":{"tags":["会话"],"summary":"清空会话消息","description":"删除指定会话的所有消息","security":[{"bearerAuth":[]}],"parameters":[{"in":"path","name":"id","required":true,"schema":{"type":"string"},"description":"会话ID"}],"responses":{"200":{"description":"消息清空成功","content":{"application/json":{"schema":{"type":"object","properties":{"success":{"type":"boolean"},"message":{"type":"string"}}}}}},"401":{"description":"未认证"},"403":{"description":"无权访问该会话"},"404":{"description":"会话不存在"},"500":{"description":"服务器错误"}}}},"/api/chat/simple":{"post":{"summary":"简单聊天接口","description":"返回ChatGPT的非流式响应","tags":["聊天"],"requestBody":{"required":true,"content":{"application/json":{"schema":{"type":"object","required":["message"],"properties":{"message":{"type":"string","description":"用户发送的消息内容","example":"你好，请介绍一下自己"}}}}}},"responses":{"200":{"description":"成功","content":{"application/json":{"schema":{"type":"object","properties":{"success":{"type":"boolean","example":true},"reply":{"type":"string","example":"你好！我是一个AI助手，可以回答问题、提供信息和帮助完成各种任务。"},"model":{"type":"string","example":"moonshot-v1-128k"},"usage":{"type":"object","properties":{"prompt_tokens":{"type":"integer","example":10},"completion_tokens":{"type":"integer","example":30},"total_tokens":{"type":"integer","example":40}}}}}}}},"400":{"description":"请求参数错误","content":{"application/json":{"schema":{"type":"object","properties":{"error":{"type":"string","example":"请提供有效的消息"}}}}}},"500":{"description":"服务器内部错误","content":{"application/json":{"schema":{"type":"object","properties":{"success":{"type":"boolean","example":false},"error":{"type":"string","example":"服务器内部错误"},"details":{"type":"string","example":"错误详情"}}}}}}}}},"/api/chat/stream":{"post":{"tags":["聊天"],"summary":"流式聊天接口","description":"使用 Server-Sent Events (SSE) 实时返回 ChatGPT 回复","requestBody":{"required":true,"content":{"application/json":{"schema":{"type":"object","required":["message"],"properties":{"message":{"type":"string","description":"用户发送的消息内容","example":"你好，请介绍一下自己"}}}}}},"responses":{"200":{"description":"返回 SSE 流","content":{"text/event-stream":{"schema":{"type":"string","description":"包含多个 SSE 事件，每个事件包含一个 JSON 对象，其中 content 字段包含回复的一部分文本","example":"data: {\"content\":\"你好\"}\n\ndata: {\"content\":\"！我是\"}\n\ndata: {\"content\":\" ChatGPT\"}\n\ndata: [DONE]\n"}}}},"400":{"description":"请求参数错误","content":{"application/json":{"schema":{"type":"object","properties":{"error":{"type":"string","example":"请提供有效的消息"}}}}}},"500":{"description":"服务器内部错误","content":{"application/json":{"schema":{"type":"object","properties":{"error":{"type":"string","example":"服务器内部错误"}}}}}}}}},"/api/users/register":{"post":{"tags":["用户管理"],"summary":"用户注册","description":"创建新用户账号","requestBody":{"required":true,"content":{"application/json":{"schema":{"type":"object","required":["username","email","password"],"properties":{"username":{"type":"string","description":"用户名"},"email":{"type":"string","format":"email","description":"电子邮件地址"},"password":{"type":"string","format":"password","description":"密码"}}}}}},"responses":{"201":{"description":"用户创建成功","content":{"application/json":{"schema":{"type":"object","properties":{"success":{"type":"boolean"},"message":{"type":"string"},"token":{"type":"string"},"user":{"type":"object","properties":{"id":{"type":"string"},"username":{"type":"string"},"email":{"type":"string"},"role":{"type":"string"}}}}}}}},"400":{"description":"请求参数错误"},"409":{"description":"用户名或邮箱已存在"},"500":{"description":"服务器错误"}}}},"/api/users/login":{"post":{"tags":["用户管理"],"summary":"用户登录","description":"使用用户名/邮箱和密码登录","requestBody":{"required":true,"content":{"application/json":{"schema":{"type":"object","required":["login","password"],"properties":{"login":{"type":"string","description":"用户名或电子邮件"},"password":{"type":"string","format":"password","description":"密码"}}}}}},"responses":{"200":{"description":"登录成功","content":{"application/json":{"schema":{"type":"object","properties":{"success":{"type":"boolean"},"message":{"type":"string"},"token":{"type":"string"},"user":{"type":"object","properties":{"id":{"type":"string"},"username":{"type":"string"},"email":{"type":"string"},"role":{"type":"string"}}}}}}}},"400":{"description":"请求参数错误"},"401":{"description":"认证失败"},"500":{"description":"服务器错误"}}}},"/api/users/me":{"get":{"tags":["用户管理"],"summary":"获取当前用户信息","description":"获取已认证用户的个人信息","security":[{"bearerAuth":[]}],"responses":{"200":{"description":"成功获取用户信息","content":{"application/json":{"schema":{"type":"object","properties":{"user":{"type":"object","properties":{"id":{"type":"string"},"username":{"type":"string"},"email":{"type":"string"},"role":{"type":"string"},"createdAt":{"type":"string","format":"date-time"},"lastLoginAt":{"type":"string","format":"date-time"}}}}}}}},"401":{"description":"未认证"},"500":{"description":"服务器错误"}}},"put":{"tags":["用户管理"],"summary":"更新当前用户信息","description":"更新已认证用户的个人信息","security":[{"bearerAuth":[]}],"requestBody":{"required":true,"content":{"application/json":{"schema":{"type":"object","properties":{"username":{"type":"string","description":"新用户名"},"email":{"type":"string","format":"email","description":"新电子邮件地址"},"currentPassword":{"type":"string","format":"password","description":"当前密码（更新密码时需要）"},"newPassword":{"type":"string","format":"password","description":"新密码"}}}}}},"responses":{"200":{"description":"用户信息更新成功","content":{"application/json":{"schema":{"type":"object","properties":{"success":{"type":"boolean"},"message":{"type":"string"},"user":{"type":"object","properties":{"id":{"type":"string"},"username":{"type":"string"},"email":{"type":"string"}}}}}}}},"400":{"description":"请求参数错误"},"401":{"description":"未认证或密码错误"},"409":{"description":"用户名或邮箱已存在"},"500":{"description":"服务器错误"}}}},"/api/users/api-key":{"post":{"tags":["用户管理"],"summary":"生成 API 密钥","description":"为当前用户生成新的 API 密钥","security":[{"bearerAuth":[]}],"responses":{"200":{"description":"API 密钥生成成功","content":{"application/json":{"schema":{"type":"object","properties":{"success":{"type":"boolean"},"message":{"type":"string"},"apiKey":{"type":"string"}}}}}},"401":{"description":"未认证"},"500":{"description":"服务器错误"}}}},"/api/users/api-usage":{"get":{"tags":["用户管理"],"summary":"获取 API 使用情况","description":"获取当前用户的 API 使用统计","security":[{"bearerAuth":[]}],"responses":{"200":{"description":"成功获取 API 使用情况","content":{"application/json":{"schema":{"type":"object","properties":{"apiKeyExists":{"type":"boolean"},"usage":{"type":"integer"},"limit":{"type":"integer"},"percentage":{"type":"number"}}}}}},"401":{"description":"未认证"},"500":{"description":"服务器错误"}}}}},"tags":[]}