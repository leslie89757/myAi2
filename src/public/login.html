<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyAI - 用户登录</title>
    <style>
        body {
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
            background-color: #f5f5f5;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            color: #333;
        }
        .login-container {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 30px;
            width: 350px;
            max-width: 90%;
        }
        h1 {
            text-align: center;
            margin-bottom: 24px;
            color: #1e88e5;
            font-weight: 500;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
        }
        input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            box-sizing: border-box;
        }
        input:focus {
            outline: none;
            border-color: #1e88e5;
            box-shadow: 0 0 0 2px rgba(30, 136, 229, 0.2);
        }
        button {
            width: 100%;
            padding: 12px;
            background-color: #1e88e5;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #1565c0;
        }
        .error-message {
            color: #e53935;
            font-size: 14px;
            margin-top: 20px;
            text-align: center;
            display: none;
        }
        .info-message {
            color: #4caf50;
            font-size: 14px;
            margin-top: 20px;
            text-align: center;
            display: none;
        }
        .logo {
            text-align: center;
            margin-bottom: 20px;
        }
        .logo img {
            width: 80px;
            height: 80px;
        }
        .register-link {
            text-align: center;
            margin-top: 16px;
            font-size: 14px;
        }
        .register-link a {
            color: #1e88e5;
            text-decoration: none;
        }
        .register-link a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="login-container">
        <div class="logo">
            <svg width="80" height="80" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 2L2 7L12 12L22 7L12 2Z" stroke="#1e88e5" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M2 17L12 22L22 17" stroke="#1e88e5" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M2 12L12 17L22 12" stroke="#1e88e5" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        </div>
        <h1>MyAI 知识库</h1>
        <div class="form-group">
            <label for="email">邮箱地址</label>
            <input type="email" id="email" placeholder="请输入您的邮箱" required>
        </div>
        <div class="form-group">
            <label for="password">密码</label>
            <input type="password" id="password" placeholder="请输入您的密码" required>
        </div>
        <button id="login-button">登录 / 注册</button>
        <div id="error-message" class="error-message"></div>
        <div id="info-message" class="info-message"></div>
        <div class="register-link">
            没有账号？直接登录将自动为您注册
        </div>
    </div>

    <script>
        // API基础URL
        const API_BASE_URL = window.location.origin;

        // DOM元素
        const loginButton = document.getElementById('login-button');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const errorMessage = document.getElementById('error-message');
        const infoMessage = document.getElementById('info-message');

        // 显示错误消息
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            infoMessage.style.display = 'none';
        }

        // 显示信息消息
        function showInfo(message) {
            infoMessage.textContent = message;
            infoMessage.style.display = 'block';
            errorMessage.style.display = 'none';
        }

        // 清除所有消息
        function clearMessages() {
            errorMessage.style.display = 'none';
            infoMessage.style.display = 'none';
        }

        // 检查用户是否已登录
        function checkLoggedIn() {
            const accessToken = localStorage.getItem('accessToken');
            const refreshToken = localStorage.getItem('refreshToken');
            
            // 如果没有令牌，不需要进一步处理
            if (!accessToken && !refreshToken) {
                return;
            }
            
            // 如果有重定向参数，不要自动跳转（让用户登录后再跳转）
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('redirect') && !accessToken) {
                return;
            }
            
            // 如果有访问令牌，尝试验证
            if (accessToken) {
                validateAccessToken(accessToken, urlParams);
            } 
            // 如果只有刷新令牌，尝试刷新
            else if (refreshToken) {
                tryRefreshToken(refreshToken);
            }
        }
        
        // 验证访问令牌
        function validateAccessToken(accessToken, urlParams) {
            fetch(`${API_BASE_URL}/api/auth/validate`, {
                headers: {
                    'Authorization': `Bearer ${accessToken}`
                }
            })
            .then(response => {
                if (!response.ok) {
                    // 如果响应不成功，尝试刷新令牌
                    if (response.status === 401) {
                        const refreshToken = localStorage.getItem('refreshToken');
                        if (refreshToken) {
                            return tryRefreshToken(refreshToken);
                        } else {
                            clearAuthStorage();
                            return { valid: false };
                        }
                    }
                    throw new Error(`验证失败: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data && data.valid) {
                    // 令牌有效，重定向到知识库页面
                    showInfo('您已登录，正在跳转到知识库...');
                    setTimeout(() => {
                        // 如果有重定向参数，跳转到指定页面
                        if (urlParams && urlParams.has('redirect')) {
                            window.location.href = urlParams.get('redirect');
                        } else {
                            window.location.href = '/knowledge-chat';
                        }
                    }, 1000);
                } else {
                    // 令牌无效，清除本地存储
                    clearAuthStorage();
                }
            })
            .catch(error => {
                console.error('验证令牌失败:', error);
                clearAuthStorage();
            });
        }

        // 清除所有认证相关的本地存储
        function clearAuthStorage() {
            localStorage.removeItem('accessToken');
            localStorage.removeItem('refreshToken');
            localStorage.removeItem('userId');
            localStorage.removeItem('username');
        }

        // 尝试使用刷新令牌获取新的访问令牌
        function tryRefreshToken(refreshToken) {
            // 如果没有传入刷新令牌，尝试从本地存储获取
            if (!refreshToken) {
                refreshToken = localStorage.getItem('refreshToken');
            }
            
            if (!refreshToken) {
                clearAuthStorage();
                return Promise.reject(new Error('无法刷新令牌：刷新令牌不存在'));
            }

            console.log('尝试刷新令牌...');
            return fetch(`${API_BASE_URL}/api/auth/refresh`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${refreshToken}`
                }
            })
            .then(response => {
                if (!response.ok) {
                    console.error(`刷新令牌失败: HTTP ${response.status}`);
                    throw new Error(`刷新令牌失败: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('刷新令牌成功，收到响应:', data);
                if (data.accessToken) {
                    // 更新本地存储中的访问令牌
                    localStorage.setItem('accessToken', data.accessToken);
                    if (data.refreshToken) {
                        localStorage.setItem('refreshToken', data.refreshToken);
                    }
                    
                    // 获取重定向参数
                    const urlParams = new URLSearchParams(window.location.search);
                    
                    // 验证新的访问令牌
                    validateAccessToken(data.accessToken, urlParams);
                    return { valid: true };
                } else {
                    console.error('刷新令牌响应中缺少访问令牌:', data);
                    throw new Error('刷新令牌响应中缺少访问令牌');
                }
            })
            .catch(error => {
                console.error('刷新令牌失败:', error);
                clearAuthStorage();
                return { valid: false };
            });
        }

        // 登录/注册函数
        function login() {
            clearMessages();
            
            const email = emailInput.value.trim();
            const password = passwordInput.value;

            if (!email) {
                showError('请输入邮箱地址');
                return;
            }

            if (!password) {
                showError('请输入密码');
                return;
            }

            // 禁用登录按钮
            loginButton.disabled = true;
            loginButton.textContent = '登录中...';

            // 清除之前的令牌
            clearAuthStorage();

            // 发送登录请求
            fetch(`${API_BASE_URL}/api/auth/login`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    login: email,
                    password: password
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`登录失败: ${response.status} ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                if (!data.accessToken) {
                    throw new Error('服务器响应中缺少访问令牌');
                }

                // 登录成功
                const isNewUser = data.isNewUser;
                
                // 保存令牌和用户信息到本地存储
                localStorage.setItem('accessToken', data.accessToken);
                localStorage.setItem('refreshToken', data.refreshToken);
                localStorage.setItem('userId', data.user.id);
                localStorage.setItem('username', data.user.username || data.user.email);
                
                // 同时将访问令牌保存到 cookie 中，用于服务器端验证
                document.cookie = `accessToken=${data.accessToken}; path=/; max-age=${60*60*24*7}; SameSite=Strict`;

                // 显示成功消息
                showInfo(isNewUser ? '注册成功，正在跳转...' : '登录成功，正在跳转...');

                // 获取重定向URL（如果有）
                const urlParams = new URLSearchParams(window.location.search);
                const redirectUrl = urlParams.get('redirect') || '/knowledge-chat';
                
                // 跳转到目标页面
                setTimeout(() => {
                    window.location.href = redirectUrl;
                }, 1500);
            })
            .catch(error => {
                console.error('登录错误:', error);
                showError(error.message || '登录失败，请检查您的邮箱和密码');
                
                // 启用登录按钮
                loginButton.disabled = false;
                loginButton.textContent = '登录 / 注册';
            });
        }

        // 添加登录按钮点击事件
        loginButton.addEventListener('click', login);

        // 添加回车键事件
        passwordInput.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                login();
            }
        });

        // 页面加载时检查登录状态
        document.addEventListener('DOMContentLoaded', checkLoggedIn);
    </script>
</body>
</html>
