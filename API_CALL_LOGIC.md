# MyAI 后端 API 调用逻辑说明

本文档简要说明 MyAI 后端 API 的调用逻辑和鉴权方式，帮助开发者理解系统的工作流程。

## API 鉴权机制

MyAI 后端使用 JWT (JSON Web Token) 进行 API 鉴权，采用双令牌机制：

1. **访问令牌 (Access Token)**
   - 短期有效（通常 30 分钟）
   - 用于访问大多数 API 端点
   - 在请求头中通过 `Authorization: Bearer <token>` 方式传递

2. **刷新令牌 (Refresh Token)**
   - 长期有效（通常 7 天）
   - 仅用于获取新的访问令牌
   - 存储在客户端，但只在刷新访问令牌时使用

### 令牌获取与刷新流程

1. 用户登录时，同时获取访问令牌和刷新令牌
2. 客户端使用访问令牌调用 API，直到令牌过期
3. 访问令牌过期后，使用刷新令牌获取新的访问令牌
4. 如果刷新令牌也过期，用户需要重新登录

### 令牌安全处理

- 访问令牌应存储在内存中，不应持久化存储
- 刷新令牌可以存储在安全的 HTTP-only cookie 或本地存储中
- 登出时应清除所有令牌

## API 调用逻辑流程

### 1. 用户认证流程

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  用户登录   │────>│ 获取令牌对  │────>│ 使用访问令牌 │────>│ 令牌验证    │
└─────────────┘     └─────────────┘     └─────────────┘     └─────────────┘
                                              │
                                              ▼
                                        ┌─────────────┐
                                        │ 令牌过期    │
                                        └─────────────┘
                                              │
                                              ▼
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  用户登出   │<────│ 继续使用API │<────│ 刷新令牌    │
└─────────────┘     └─────────────┘     └─────────────┘
```

1. **登录/注册**：`POST /api/auth/login` → 获取访问令牌和刷新令牌
2. **验证令牌**：每次 API 调用前客户端应确保令牌有效
3. **刷新令牌**：访问令牌过期时，使用刷新令牌获取新的访问令牌
4. **登出**：使当前的令牌失效

### 2. 会话管理流程

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│ 获取会话列表 │────>│ 创建新会话  │────>│ 添加会话消息 │
└─────────────┘     └─────────────┘     └─────────────┘
                                              │
                                              ▼
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  删除会话   │<────│  更新会话   │<────│ 清空会话消息 │
└─────────────┘     └─────────────┘     └─────────────┘
```

- 所有会话操作都需要有效的访问令牌
- 会话操作通常在用户完成认证后进行
- 会话 ID 在创建时由服务器生成，后续操作需要使用此 ID

### 3. 知识库使用流程

```
┌─────────────┐
│ 上传知识文件 │
└─────────────┘
      │
      ▼
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│ 查询知识库  │────>│ 知识库聊天  │────>│ 流式聊天响应 │
└─────────────┘     └─────────────┘     └─────────────┘
      │
      ▼
┌─────────────┐
│ 删除知识库  │
└─────────────┘
```

- 知识库操作需要指定用户 ID，确保数据隔离
- 文件上传使用 `multipart/form-data` 格式
- 流式聊天使用 Server-Sent Events (SSE) 技术

## 关键调用序列

### 典型用户会话流程

1. **用户登录**
   ```
   POST /api/auth/login
   → 获取访问令牌和刷新令牌
   ```

2. **获取或创建会话**
   ```
   GET /api/sessions
   → 如果没有会话，创建新会话
   POST /api/sessions
   ```

3. **上传知识库文件**（如果需要）
   ```
   POST /api/knowledge/upload
   → 文件被处理并添加到知识库
   ```

4. **与知识库交互**
   ```
   POST /api/knowledge/query 或 POST /api/knowledge/chat
   → 获取知识库响应
   ```

5. **将消息保存到会话**
   ```
   POST /api/sessions/{id}/messages
   → 消息被保存到数据库
   ```

6. **定期刷新令牌**
   ```
   POST /api/auth/refresh
   → 获取新的访问令牌
   ```

7. **用户登出**
   ```
   POST /api/auth/logout
   → 令牌被失效
   ```

## 错误处理逻辑

1. **认证错误** (401)
   - 访问令牌无效或过期 → 尝试刷新令牌
   - 刷新令牌无效或过期 → 重定向到登录页面

2. **权限错误** (403)
   - 用户尝试访问无权限资源 → 显示权限不足提示

3. **资源不存在** (404)
   - 会话或知识库不存在 → 返回到列表页面

4. **服务器错误** (500)
   - 服务器内部错误 → 显示友好错误信息并记录日志

## 前端实现建议

1. **令牌管理**
   - 使用内存存储访问令牌
   - 使用 HTTP-only cookie 存储刷新令牌
   - 实现自动令牌刷新机制

2. **请求拦截器**
   - 为所有请求自动添加访问令牌
   - 捕获 401 错误并触发令牌刷新
   - 刷新成功后重试原请求

3. **流式响应处理**
   - 使用 EventSource 接收流式聊天响应
   - 实现渐进式内容显示
   - 处理连接中断和重连逻辑

## 安全注意事项

1. **令牌安全**
   - 永远不要在客户端代码中硬编码令牌
   - 不要在 URL 中传递令牌
   - 使用 HTTPS 加密所有 API 通信

2. **输入验证**
   - 所有用户输入在发送到服务器前应进行验证
   - 文件上传应限制大小和类型

3. **敏感数据处理**
   - 不要在客户端存储敏感用户数据
   - 最小化请求和响应中的敏感信息
